-- 1757. Recyclable and Low Fat Products
SELECT product_id FROM Products
WHERE low_fats = 'Y' AND recyclable = 'Y'ï¼›

-- 584. Find Customer Referee
SELECT name FROM Customer
WHERE referee_id <> 2 OR referee_id IS NULL

-- 595. Big Countries
SELECT name, population, area 
FROM world
WHERE area >= 3000000 OR population >= 25000000

-- 1148. Article Views 1
SELECT DISTINCT author_id AS id
FROM views
WHERE author_id = viewer_id
ORDER BY id ASC

-- 1683. Invalid Tweets
SELECT tweet_id 
FROM tweets
WHERE LENGTH(content) > 15

-- 1378. Replace Employee ID With The Unique Identifier
SELECT eu.unique_id, e.name
FROM Employees e
LEFT JOIN EmployeeUNI eu
ON e.id = eu.id

-- 1068. Product Sales Analysis 1
SELECT p.product_name, s.year, s.price
FROM sales s
LEFT JOIN product p
ON s.product_id = p.product_id

-- 1581. Customer Who Visited but Did Not Make Any Transactions
SELECT v.customer_id, COUNT(v.customer_id) as count_no_trans
FROM Visits v
LEFT JOIN Transactions t
ON v.visit_id = t.visit_id
WHERE t.transaction_id IS NULL
GROUP BY v.customer_id

-- 197. Rising Temperature
SELECT w2.id
FROM weather w1 
JOIN weather w2 
ON DATEDIFF(w1.recordDate, w2.recordDate) = -1 AND w2.temperature > w1.temperature

-- 1661. Average Time of Process per Machine
SELECT a1.machine_id, ROUND(AVG(a2.timestamp - a1.timestamp),3) as processing_time
FROM activity a1
LEFT JOIN activity a2
ON a1.machine_id = a2.machine_id AND a1.process_id = a2.process_id
WHERE a1.activity_type = 'start' AND a2.activity_type = 'end'
GROUP BY a1.machine_id

-- 577. Employee Bonus
SELECT e.name, b.bonus
FROM employee e
LEFT JOIN bonus b
ON e.empId = b.empID
WHERE COALESCE(bonus, 0 ) < 1000
 
-- alternative: WHERE bonus < 1000 or bonus IS NULL

-- 1280. Students and Examinations
SELECT data.student_id, data.student_name, data.subject_name, COALESCE(subject.attended_exams,0) as attended_exams
FROM 
(SELECT student_id, subject_name, COUNT(subject_name) as attended_exams
FROM examinations
GROUP BY student_id, subject_name) as subject

RIGHT JOIN (
    SELECT *
    FROM students
    CROSS JOIN subjects
) as data
ON data.student_id = subject.student_id and data.subject_name = subject.subject_name
ORDER BY data.student_id, data.subject_name

-- 570. Managers with at Least 5 Direct Reports
SELECT b.id
FROM employee a
JOIN employee b
ON a.managerId = b.id
GROUP BY b.id, b.name
HAVING count(a.id)>5

-- 1934. Confirmation Rate
-- Solution 1
SELECT s.user_id, ROUND(COALESCE(SUM(CASE WHEN c.action = 'confirmed' THEN c.cnt ELSE 0 END) * 1/SUM(c.cnt),0),2) AS confirmation_rate
FROM signups s
LEFT JOIN 
(SELECT user_id, action, COUNT(action) AS cnt
FROM confirmations
GROUP BY user_id, action) AS c
ON s.user_id = c.user_id
GROUP BY s.user_id

-- Solution 2
SELECT s.user_id, ROUND(AVG(CASE WHEN c.action = 'confirmed' THEN 1 ELSE 0 END),2) as confirmation_rate
FROM signups s
LEFT JOIN confirmations c
ON s.user_id = c.user_id
GROUP BY s.user_id

-- 620. Not Boring Movies
SELECT * 
FROM cinema
WHERE description NOT LIKE 'boring' AND id % 2 <> 0
ORDER BY rating DESC

-- 1251. Average Selling Price
SELECT p.product_id, COALESCE(ROUND(SUM(p.price * u.units) /SUM(units),2),0) AS average_price
FROM prices p
LEFT JOIN UnitsSold u
ON p.product_id = u.product_id AND u.purchase_date BETWEEN p.start_date AND p.end_date
GROUP BY p.product_id

-- 1075. Project Employees I
SELECT p.project_id, ROUND(AVG(e.experience_years),2) AS average_years
FROM project p
LEFT JOIN employee e
ON p.employee_id = e.employee_id
GROUP BY p.project_id

-- 1633. Percentage of Users Attended a Contest
SELECT 
contest_id, 
round(
    (count(user_id)
    /
    (SELECT COUNT(DISTINCT user_id) FROM users))
    *100,2) as percentage
FROM register
GROUP BY contest_id
ORDER BY percentage DESC, contest_id ASC

-- 1211. Queries Quality and Percentage
SELECT 
query_name, 
ROUND(AVG(rating/position),2) AS quality,
-- ROUND(SUM(rating < 3) / COUNT(rating) * 100,2) AS poor_query_percentage
-- ROUND(SUM(CASE WHEN rating < 3 THEN 1 ELSE 0 END)/COUNT(rating) * 100,2) AS poor_query_percentage
ROUND(SUM(IF(rating<3,1,0))/COUNT(rating) *100,2) AS poor_query_percentage
FROM queries
GROUP BY query_name

-- 1193. Monthly Transactions I
SELECT 
DATE_FORMAT(trans_date, '%Y-%m') AS month, 
country, 
COUNT('id') AS trans_count, 
SUM(IF(state = 'approved',1,0)) AS approved_count, 
SUM(amount) AS trans_total_amount, 
sum(IF(state = 'approved',amount,0)) AS approved_total_amount
FROM transactions
GROUP BY month,country

-- 1174. Immediate Food Delivery II
WITH first_order AS (
    SELECT customer_id, MIN(order_date) as order_date
    FROM delivery
    GROUP BY customer_id  
)

SELECT ROUND(AVG(d.order_date = d.customer_pref_delivery_date)*100,2) as immediate_percentage 
FROM delivery d
JOIN first_order a
ON d.order_date = a.order_date and d.customer_id = a.customer_id

-- 550. Game Play Analysis IV
SELECT round(COUNT(DISTINCT b.player_id)/COUNT(DISTINCT a.player_id),2) as fraction
FROM (
    SELECT player_id, MIN(event_date) AS first_login 
    FROM activity 
    GROUP BY player_id
    ) a
LEFT JOIN activity b 
ON a.player_id = b.player_id AND DATEDIFF(a.first_login, b.event_date) = -1

-- 2356. Number of Unique Subjects Taught by Each Teacher
SELECT teacher_id, COUNT(DISTINCT subject_id) as cnt
FROM teacher
GROUP BY teacher_id

-- 1141. User Activity for the Past 30 Days I
SELECT activity_date as day, COUNT(DISTINCT user_id) as active_users
FROM activity
WHERE DATEDIFF('2019-07-27', activity_date) < 30 AND activity_date <= '2019-07-27'
GROUP BY activity_date

-- 1070. Product Sales Analysis III
SELECT a.product_id, a.first_year, b.quantity, b.price
FROM 
(SELECT product_id, min(year) AS first_year FROM sales GROUP BY product_id) a
JOIN sales b
ON a.product_id = b.product_id AND a.first_year = b.year

-- 596. Classes With at Least 5 Students
SELECT class
FROM courses
GROUP BY class
HAVING COUNT(student) >= 5

-- 1729. Find Followers Count
SELECT user_id, COUNT(follower_id) as followers_count
FROM followers
GROUP BY user_id
ORDER BY user_id ASC

-- 619. Biggest Single Number
SELECT MAX(a.num) as num
FROM (SELECT num
FROM MyNumbers
GROUP BY num
HAVING COUNT(num) = 1) a

-- 1045. Customers Who Bought All Products
SELECT customer_id
FROM customer 
GROUP BY customer_id
HAVING COUNT(DISTINCT product_key) = (SELECT COUNT(*) FROM product)
